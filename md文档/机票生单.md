##### 机票生单

大的系统模块：主系统、子单系统：辅营营销保险子系统、交易系统、报价系统、基础数据

主站系统：网关层数据唯一出入口和数据整合层

子单系统：营销、保险、辅营等商品

交易系统：交易数据的落库，支付前校验和支付中心进行交互，包括禁售功能、发起生编操作

报价系统：提供报价搜索与整合、填单页booing等功能

基础数据：与航信打交道，提供生编，pata指令等操作

合单（相对单个订单而言）：通过交易网关trade_order对一次booking进行请求拆分（如果只有一个单，只请求一次）后，多次请求核心交易层trade_core生成多个单，即对应多个机票单。

为什么要拆单？

​	为了符合代理和航司和一些规则，需要对航程或乘机人进行拆分。

##### 政策类型代理和直连类型代理

政策类型代理：某些代理不提供直连接口，或者说没有能力提供自己的接口，在去哪儿投放报价等政策

直连类型代理：这种代理自己跟航信打交道，可以提供直连接口（有自己的生编接口、验座、验价接口）

#### 生编与生单

​	生编：跟GDS相关，去航信占座
​	生单：数据库落库

#### 同步生单和异步生单
​	同步生单大致流程：交易网关trade_order对一次booking进行请求拆分后，多次请求核心交易层trade_core生成多个单，经过校验和判断后到达db层落库

​	异步生单大致流程：trade_order发送qmq消息到达trade_core时会触发异步生单的流程，异步流程的结果作为数据基础提供给支付前校验流程。trade_core有两个大的链路，直连类接口和政策类接口，直连类接口直接调用f_tts_afare_booking，政策类是去哪儿自己包装的一些接口（主要和航信打交道），如f_tts_smart_pnr（航信指令层）和f_avdb，生编、验价后，整个异步流程算是完成了，完成后会更新机票信息。


trade_order为什么直接调用多报价查询：如果是多报价的话，会对booking进行拆分（拆分成多个请求）。一次booking中确定好生哪个代理的单之后，其中的某些乘机人不满足这个报价，这时候需要进行拆分，这就是为什么有拆单流程的原因，拆单主要分为乘机人拆分和航程拆分（中转、往返）两种类型

请求生成营销、辅营等子单流程：依附于机票单的各个子单，由trade_order发起

#### 总体流程

​	用户通过客户端，请求打过来，通过主系统的网关demoestic_tts之后，来到交易生单网关层trade_order，trade_order网关层经过一系列逻辑校验，对请求进行拆分，来到核心交易层trade_core，再经过校验后落库，即同步生单。



