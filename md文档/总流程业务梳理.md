#### 代理类型

+ 运价直连：某些代理有开发能力，他们维护了自己的价格仓位等信息，提供了接口，直接调用他们的接口进行生单就可以。
+ 第三方：去哪儿平台有一个开放平台，代理在去哪儿平台录入信息。

#### 基础数据

+ AV：指航班及舱位数据缓存，通过AV指令从航信获取到实时的航班的时间、经停、航站楼、餐食、舱位及舱位状态代码等信息
+ FD：类似于AV，含有时间、航空公司、城市、舱位等信息，用于计算运价


#### 不同的价格
+ 运价：从全球分销系统GDS获取，所有代理商都能看到运价
+ 政策价：GDS运价出来后，给到不同的代理商，同时给代理商有一些优惠，然后代理商给出政策价
+ 包装价：平台在政策价的基础上加一点，就是包装价
+ 售卖价：通常情况下≈包装价


#### 搜索List页
+ 展示了航班的基础信息，如航司、时间、价格，从航线维度的报价信息（指包装价，包装价通常是200多个代理中的最低价），航班列表页按照航班或者航班组合（中转、往返）维度展示最低价

  ![image-20221009213336040](https://shan-edu.oss-cn-chengdu.aliyuncs.com/img/image-20221009213336040.png)


#### 搜索OTA
+ OTA页按照包装报价类型（如旗舰店、自营、普通代理商的低价特惠、商旅优选）展示最低价

+ 以tag为维度切分，搜索OTA页显示的是tag维度的最低价，一个tag包含某个航班的所有信息，时间、餐食、行李额、退改政策，还有一些商品和服务，例如优酷会员月卡、优享保障服务等

  ![image-20221009213351811](https://shan-edu.oss-cn-chengdu.aliyuncs.com/img/image-20221009213351811.png)


#### booking页
+ 通过booking tag key中能获取搜索OTA页内的所有信息，booking页可以填乘机人等信息，还有一些辅营产品的推荐、例如保险、升舱以及行程单服务。

  ![image-20221009213406351](https://shan-edu.oss-cn-chengdu.aliyuncs.com/img/image-20221009213406351.png)

#### 生单
+ 聚合生单：在用户选择了其他服务的时候（例如辅营产品、保险、酒店等），需要调用其他服务的接口聚合，对所有子单进行生单后聚合，聚合后进行落库的前置校验（主要有一些通用校验、特殊报价的校验、风控校验），没问题就进行落库
+ 合单与非合单（售前的概念）：
  + **实际上是拆分的动作**，落库时是多个订单号，是把一次booking请求拆分成多个，多次请求核心交易层trade_core生成多个单（N单），
    +  场景：1.上海往返北京，生成了两个N单  2.有3个乘机人，但是该代理商只有2个座位了，另外一个乘机人就给另外的代理商，但这也叫合单（实际上是拆分的动作）3.
  + 非合单：只生一个N单
    + 场景：一个人买单程，多个人买同一个booking的报价，中转包（两段都是同一航司的报价）、往返包（往返都是同一航司的报价）
  + **怎么知道是不是合单**：下单的时候看trade_core中是tts.log日志，多个订单即合单（会有多个N单号），或者查看shop_core的库（存订单关系的）通过20单号查
+ 不同的单号
  + 20单：订单详情看到的单子，主要给用户展示，并且绑定订单关系使用 (203058783905)
  + N单：代理商单号，是面向客户的，一般由代理商的domain前三个字母加一串数字组成，主要**售前交易阶段使用**，用来绑定一些子单信息，和支付中心等其他系统交互，存储该订单对应的其他子单信息时使用 (xep220921214933440)
  + F单是面向代理商的，**派单**阶段生成，售后使用：退改签、出票等，一般是N单最后加001（xep220921214933440001）

+ 同步生单和异步生单

  在点击去支付后，在等待的过程中会进行生单，分为同步生单和异步生单，主要是为了降低用户对于生单时间的感知，从而提高用户体验

  + 同步生单主要做一些参数组装、参数校验、落库，耗时较短，是在用户点击【去支付】的同时进行的操作
  + 异步生单主要做生编、验价、判恶意，这些操作与航信交互，耗时较长，用户在点击【去支付】到唤起收银台的过程中不必等待异步生单的校验完成

+ 多报价

  + ota展示的特殊报价，在`trade_booking`阶段会进行预搜存缓存，用户在生单时，交易会调用`trade_booking`传乘机人和报价信息，由`trade_booking`来校验乘机人是否满足该报价，不满足则会返回之前预搜好的可以使用的报价（兜底报价），交易会给用户进行多报价弹窗并提示用户是否使用新报价生单

    ![image-20221009204647712](https://shan-edu.oss-cn-chengdu.aliyuncs.com/img/image-20221009204647712.png)

    ![image-20221009204710251](https://shan-edu.oss-cn-chengdu.aliyuncs.com/img/image-20221009204710251.png)

#### 同步生单和异步生单怎么触发

+ 生单是由主站组装**乘机人信息**和**订单信息**以及**bookingTag**传给交易，交易通过bookingTag在redis中取出订单携带的其他营销、辅营等信息，从而调各个子系统生相对应订单

  **同步生单**通过用户点击前端【去支付】按钮触发

  **异步生单**是在同步生单结束且同步生单成功后，trade_order会给trade_core发送一个qmq消息触发异步生单，异步生单的数据主要给支付前校验使用

  **如果同步生单的校验失败则会直接在【去支付】的等待过程中提示失败**；但是异步校验失败不会影响唤起收银台的过程，会在后面的流程中才会使用这个校验结果

#### 生单交互

主站会调用trade_order，trade_order会调用trade_core来生机票单，同时调用辅营、营销、机酒的子单，子单生单失败后并不会影响主流程机票的生单，**但如果机票单失败，则不能生单**，生单成功后会进行落库

#### 唤起收银台（gopay）

根据订单号获取订单信息和策略给用户展示支付信息和可用的支付渠道，因为有一些机票的报价只支持个别渠道，如拿去花

1. 调order_detail根据20单号获取N单号，查询订单基础信息

2. 调trade_order查询子单信息，辅营、营销等

3. 调trade_pay来返回goPay信息，机票报价+辅营+营销

![image-20221009211600681](https://shan-edu.oss-cn-chengdu.aliyuncs.com/img/image-20221009211600681.png)

#### 支付前校验
+ 支付前校验主要是在校验异步生单的一些数据，需要验价和验座，如果变价会给用户进行提示或者失
+ 验价：现在的FD价格是从报价组的Cache中拿到的，但是FD经常会变化，因此需要调用基础数据的API，使用GDS指令获取最新的FD价格，会维护一组有梯度的阈值，如果价格差在一级阈值范围内，用户可以直接下单，费用差距由公司承担，如果超出一级阈值，用户点击“去支付”时会有弹窗显示价格已经发生变化，是否还要继续预定。超出二级阈值后，直接提示机票价格发生已变化，下单失败。
+ 验座：通过PNR（Passenger Name Record，旅客信息记录）进行验座，当占座时间较长还未下单，PNR会被取消，所以需要验座
+ 支付前校验**一般是唤起收银台**，用户输完密码由支付中心->主站->trade_pay->trade_core来触发，支付前校验成功后取到支付参数再拉起第三方进行支付扣款，所以只有支付前校验成功了才会扣款，否则就算输了密码也不会扣钱。扣款成功后对订单信息进行状态扭转

#### 支付前校验数据来源

+ **支付前校验的数据是异步生单后存入缓存，在支付前校验从缓存中取出然后进行校验，支付中心->主站->trade_pay->trade_core**
#### 支付后回调

+ 总单：聚合方要知道总价格，然后给用户展示
+ 子单：各子单要知道自己的价格，例如用户选择了其他辅营产品，对于每个产品，都需要生成自己的子单


#### 派单
+ 派单主要有两种，N单和F单
+ N单：代理商单号，是面向客户的，一般由代理商的domain前三个字母加一串数字组成，主要**售前交易阶段使用**，用来绑定一些子单信息，和支付中心等其他系统交互，存储该订单对应的其他子单信息时使用 (xep220921214933440)
+ F单是面向代理商的，**派单**阶段生成，售后使用：退改签、出票等，一般是N单最后加001（xep220921214933440001）


#### 出票后与交易相关的业务
+ 航变、改签、退票
+ 改签、退票时可能整单进行操作，也可能涉及一部分单子，这时候需要**拆单**，**原单取消，在新单上进行操作**。
