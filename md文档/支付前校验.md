##### 支付前校验

1. 支付前校验处在交易环节的哪一步？

   用户在生单完跳收银台有一个支付确认的操作，当用户进行支付确认的时候，支付中心客户端会调用主站，然后调用业务节点，发起支付前校验，校验成功后支付中心拿到支付参数才会真正调用第三方渠道去发起支付

2. 涉及到哪些功能？

   进行进一步的确认，包括支付金额，涉及到子单（酒店、营销、辅营）的支付参数，子单参数聚合后返回给支付中心。

   trade_core：机票订单本身的核心功能，占座、验舱和验价

   trade_pay：负责统一调用各个子单的支付校验及获取支付参数并进行聚合。

   主站：相当于网关层的功能，合单和非合单的拆分也是主站来做

   辅营：子单信息的聚合

   报价：机票所有的信息，商品的组合依赖于报价，支付前校验的时候依赖报价的一些基础信息，比如政策、退改信息、包装信息。还涉及到机票的验舱验价时涉及的变价之后进行价格重算以及验舱验价失败重搜由报价来做的

   基础数据：用户买机票的时候涉及到占座，占座在系统交互的维度中可以说是生编（政策）或者生单（运价直连，上代理、航信或者航司那边生单），基础数据主要跟航信打交道，封装一些占座、验舱验价的一些接口。

   

   运价直连：代理有能力自己去跟航信、航司打交道，运价直连提供一套占座验舱验价的一套网关，这套网关去跟具体的代理打交道

   

   生完编或者代理生完单后，这个编号或者单号有一个有效期，验舱其实就是验这个编或者单号的有效性，如果用户下单后长时间不去支付可能会被代理或者航司进行取消、如果不做这个校验的话可能出现用户支付后最后不能出票，因为生编或者航司生单后才能出票。

   验价：占座后，舱位的价格会动态变化，需要看在支付的时候跟用户下单的时候价格有没有变化，通过验价来规避由于航司变价导致的一些损失。如果发生了变化，有两个变化阈值，要么弹窗提示价格发生变化告知用户是否继续下单，要么直接就支付失败。

3. 涉及到的核心功能以及为什么要有这些功能

   支付前校验核心的就是机票这块的功能：占座验舱验价，这几个动作比较容易出现问题，这也是支付前校验的一个核心环节，也是难点。

4. 怎么提高支付前校验的成功率
   1. 变价提示（发生变价后，交易这边会调用报价，重算包装价，如果超过变价阈值，交易给主站返回支付前校验变价，主站再返给支付中心 ，支付中心拿到变价信息后重新再发一次支付前校验，把支付前校验的信息修正确认之后再发起第三方渠道发起支付）
   2. 失败兜底（给用户换一个报价，调用主站，发起重搜，换报价成功后，用新的报价去发起占座验舱验价，重新拿到新的报价，拼新的支付前校验参数给支付中心，然后支付中心再发起支付。）

以上都是非合单的场景，合单场景不同之处：针对一个机票订单还是多个区分，如果是多个机票单发起支付前校验叫合单，调支付中心存储支付参数时候由谁来发起，如果非合单是主站，支付中心调主站，主站拿到支付参数去调支付中心。

合单：由支付中心调主站，主站调用订单详情中的合单信息，再调交易的合单支付前校验的接口，再分别调每个子单（机票）的支付前校验，拿到参数后，由trade_pay发起调用支付中心存储支付中心，再返给主站，再返支付中心。主站返给支付中心时会拿到一个总的订单编号（总单单号），通过总单单号拿到所有已经存储的PayForm信息，调用第三方渠道。

1. trade_core大的调用链：
   1. P4.1和P5步骤中主要是进行验舱和验价，分别调用了基础数据（政策类代理）和运价直连（直连类代理）的接口
   2. 左下角调用了报价的接口，发生变价后，trade_core这边会调用报价，重算包装价，如果超过变价阈值，trade_pay给主站返回支付前校验变价信息，主站再返给支付中心 ，支付中心拿到变价信息后重新再发一次支付前校验，把支付前校验的信息修正确认之后再发起第三方渠道发起支付

